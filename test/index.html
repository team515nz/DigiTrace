<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>מערכת ניתוח חפירות ארכיאולוגיות 3D</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🏺 מערכת ניתוח חפירות ארכיאולוגיות 3D</h1>
            <p>העלאת מודלים תלת-ממדיים וניתוח שכבות חפירה • יישור גמיש עם מספר נקודות</p>
        </div>

        <div class="content">
            <div class="sidebar">
                <div class="upload-section">
                    <h3>📁 העלאת מודלים</h3>
                    <div class="upload-box" id="uploadBox" onclick="document.getElementById('fileInput').click()">
                        <div class="upload-icon">📤</div>
                        <div>לחץ להעלאת קובץ 3D</div>
                        <small class="text-muted">
                            OBJ, STL, GLB, GLTF
                            <span class="format-badge">NEW</span>
                        </small>
                    </div>
                    <div id="loadingMessage" class="loading-message hidden"></div>
                    <input type="file" id="fileInput" class="file-input" accept=".obj,.stl,.glb,.gltf" multiple>
                </div>

                <div class="upload-section">
                    <h3>📋 מודלים שהועלו</h3>
                    <div id="modelList" class="model-list"></div>
                </div>

                <div class="upload-section hidden" id="downloadSection">
                    <h3>📥 הורדת מודל משולב</h3>
                    <div class="download-box">
                        <select id="exportFormat" class="format-select">
                            <option value="stl">STL</option>
                            <option value="obj">OBJ</option>
                            <option value="glb">GLB</option>
                            <option value="gltf">GLTF</option>
                        </select>
                        <button class="download-btn" onclick="downloadCombinedModel()">
                            📥 הורד מודל משולב (עם סיבוב)
                        </button>
                    </div>
                </div>

                <div class="upload-section hidden" id="alignSection">
                    <div class="align-section">
                        <h4>🎯 יישור מודלים גמיש</h4>
                        <div class="align-controls">
                            <div class="align-info" id="alignStatus">
                                לחץ על 📍 ליד מודל ובחר נקודות עליו
                            </div>
                            <div class="point-counter" id="pointCounter">
                                מודל 1: 0 נקודות | מודל 2: 0 נקודות
                            </div>
                            <button class="align-action-btn hidden" id="finishModelBtn" onclick="finishCurrentModel()">
                                סיים מודל נוכחי →
                            </button>
                            <button class="align-action-btn hidden" id="undoPointBtn" onclick="undoLastPoint()">
                                ↶ מחק נקודה אחרונה
                            </button>
                            <button class="align-execute-btn" id="executeAlignBtn" onclick="executeAlignment()" disabled>
                                יישר מודלים
                            </button>
                            <button class="align-execute-btn cancel-btn" onclick="cancelAlignment()">
                                ביטול
                            </button>
                        </div>
                    </div>
                </div>

                <!-- מדידת מרחק -->
                <div class="upload-section">
                    <h3>📏 מדידת מרחק</h3>
                    <button class="measure-btn" onclick="toggleMeasureMode()" id="measureBtn">
                        🎯 התחל מדידה
                    </button>
                    <div id="measureInfo" class="measure-info hidden">
                        <div id="measureStatus">בחר נקודה ראשונה...</div>
                        <div id="measureDistance" class="measure-distance"></div>
                    </div>
                </div>

                <!-- כיול -->
                <div class="upload-section">
                    <h3>📐 כיול מידות</h3>
                    <button class="calibrate-btn" onclick="toggleCalibrateMode()" id="calibrateBtn">
                        📐 כיול מודל
                    </button>
                    <div id="calibrateInfo" class="calibrate-info hidden">
                        <div id="calibrateStatus">בחר נקודה ראשונה...</div>
                        <div class="calibrate-input-group">
                            <label for="calibrateValue">מרחק ידוע (יח'):</label>
                            <input type="number" id="calibrateValue" class="calibrate-input" 
                                   placeholder="לדוגמה: 1.0" step="0.01" min="0.01">
                            <button class="calibrate-apply-btn" onclick="applyCalibration()" id="applyCalBtn" disabled>
                                ✓ החל כיול
                            </button>
                        </div>
                        <div id="calibrateResult" class="calibrate-result"></div>
                    </div>
                    <div id="calibrateDisplay" class="calibrate-display hidden">
                        <strong>כיול פעיל:</strong>
                        <div id="calibrateFactorText"></div>
                        <button class="calibrate-reset-btn" onclick="resetCalibration()">
                            🔄 אפס כיול
                        </button>
                    </div>
                </div>
            </div>

            <div class="main-content">
                <div class="controls">
                    <button class="fullscreen-btn" onclick="toggleFullscreen()">🖵 מסך מלא</button>
                    
                    <div class="control-group">
                        <label>
                            <span class="value-display" id="cutYValue">חיתוך אנכי: 0%</span>
                            חיתוך מלמעלה למטה
                        </label>
                        <input type="range" id="cutY" class="slider" min="0" max="100" value="0">
                    </div>

                    <div class="control-group">
                        <label>
                            <span class="value-display" id="cutXValue">חיתוך רוחב: 0%</span>
                            חיתוך משמאל לימין
                        </label>
                        <input type="range" id="cutX" class="slider" min="0" max="100" value="0">
                    </div>

                    <div class="control-group">
                        <label>
                            <span class="value-display" id="cutZValue">חיתוך עומק: 0%</span>
                            חיתוך מאחורה לקדימה
                        </label>
                        <input type="range" id="cutZ" class="slider" min="0" max="100" value="0">
                    </div>

                    <!-- בקרות סיבוב -->
                    <div class="section-divider">סיבוב המודל</div>
                    
                    <div class="control-group">
                        <label>
                            <span class="value-display" id="rotXValue">סיבוב X: 0°</span>
                            סיבוב סביב ציר X
                        </label>
                        <input type="range" id="rotX" class="slider" min="0" max="360" value="0">
                    </div>

                    <div class="control-group">
                        <label>
                            <span class="value-display" id="rotYValue">סיבוב Y: 0°</span>
                            סיבוב סביב ציר Y
                        </label>
                        <input type="range" id="rotY" class="slider" min="0" max="360" value="0">
                    </div>

                    <div class="control-group">
                        <label>
                            <span class="value-display" id="rotZValue">סיבוב Z: 0°</span>
                            סיבוב סביב ציר Z
                        </label>
                        <input type="range" id="rotZ" class="slider" min="0" max="360" value="0">
                    </div>

                    <button class="reset-rotation-btn" onclick="resetRotation()">
                        🔄 אפס סיבוב
                    </button>
                </div>

                <button class="close-fullscreen" onclick="toggleFullscreen()">✕ סגור מסך מלא</button>
                
                <div class="fullscreen-controls" id="fullscreenControls">
                    <div class="control-group">
                        <label>
                            <span class="value-display" id="cutYValueFS">חיתוך אנכי: 0%</span>
                            חיתוך מלמעלה למטה
                        </label>
                        <input type="range" id="cutYFS" class="slider" min="0" max="100" value="0">
                    </div>

                    <div class="control-group">
                        <label>
                            <span class="value-display" id="cutXValueFS">חיתוך רוחב: 0%</span>
                            חיתוך משמאל לימין
                        </label>
                        <input type="range" id="cutXFS" class="slider" min="0" max="100" value="0">
                    </div>

                    <div class="control-group">
                        <label>
                            <span class="value-display" id="cutZValueFS">חיתוך עומק: 0%</span>
                            חיתוך מאחורה לקדימה
                        </label>
                        <input type="range" id="cutZFS" class="slider" min="0" max="100" value="0">
                    </div>

                    <div class="section-divider">סיבוב המודל</div>
                    
                    <div class="control-group">
                        <label>
                            <span class="value-display" id="rotXValueFS">סיבוב X: 0°</span>
                            סיבוב סביב ציר X
                        </label>
                        <input type="range" id="rotXFS" class="slider" min="0" max="360" value="0">
                    </div>

                    <div class="control-group">
                        <label>
                            <span class="value-display" id="rotYValueFS">סיבוב Y: 0°</span>
                            סיבוב סביב ציר Y
                        </label>
                        <input type="range" id="rotYFS" class="slider" min="0" max="360" value="0">
                    </div>

                    <div class="control-group">
                        <label>
                            <span class="value-display" id="rotZValueFS">סיבוב Z: 0°</span>
                            סיבוב סביב ציר Z
                        </label>
                        <input type="range" id="rotZFS" class="slider" min="0" max="360" value="0">
                    </div>

                    <button class="reset-rotation-btn" onclick="resetRotation()">
                        🔄 אפס סיבוב
                    </button>
                </div>

                <div class="viewer viewer-flex">
                    <div id="canvas-container">
                        <div class="instruction">
                            <div class="instruction-icon">🏛️</div>
                            <div>העלה מודלים תלת-ממדיים כדי להתחיל</div>
                            <div class="instruction-hint">
                                תוכל להעלות מספר מודלים ולראות את השכבות אחת על השנייה<br>
                                <strong>תמיכה מלאה ב: OBJ, STL, GLB, GLTF</strong><br>
                                <strong>יישור גמיש: בחר כמה נקודות שתרצה!</strong>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="model-viewer.js"></script>
</body>
</html>
